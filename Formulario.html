<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unimedic IPS</title>
  <link rel="stylesheet" href="Estilos.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>
<body>
  <header>
    <img src="img/logo unimedic.png" alt="Logo Unimedic" />
    <h1>¬© Unimedic IPS</h1>
   
    <nav>
      <a href="index.html">Inicio</a>
      <a href="mision.html">Misi√≥n</a>
      <a href="vision.html">Visi√≥n</a>
      <a href="Quienes-somos.html">Qui√©nes Somos</a>
      <a href="valores.html">Valores</a>
      <a href="servicios.html">Servicios</a>
      <a href="contacto.html">Contacto</a>
      <a href="Tecnologias.html">Tecnolog√≠as</a>
      <a href="Informe_tecnico.html">Informe t√©cnico</a>
      <a href="Formulario.html">Formulario</a>
    </nav>
    
 <button id="cerrarSesion" class="btn btn-danger" style="position: fixed; top: 20px; right: 20px;">
  Cerrar sesi√≥n
</button>
  </header>
<script>
  // ‚úÖ Protecci√≥n de acceso
  const sesion = JSON.parse(localStorage.getItem("sesionActiva"));
  if (!sesion) {
    alert("Debes iniciar sesi√≥n para acceder al sistema.");
    window.location.href = "login.html";
  }
  // üîí Cerrar sesi√≥n
document.getElementById("cerrarSesion").addEventListener("click", () => {
  localStorage.removeItem("sesionActiva");
  window.location.href = "login.html";
});

</script>

  

  <main class="container my-4">
    <!-- ===================================================
         üìå GESTI√ìN DE M√âDICOS
    =================================================== -->
    <h2>Gesti√≥n de M√©dicos</h2>
    <form id="formMedico" class="mb-3">
      <input placeholder="Nombres" id="nombreMedico" required />
      <input placeholder="Apellidos" id="apellidoMedico" required />
      <input placeholder="ID" id="idMedico" required />
      <select id="espMedico" required>
        <option value="">Especialidad</option>
        <option>Gastroenterolog√≠a</option>
        <option>Endocrinolog√≠a</option>
        <option>Cardiolog√≠a</option>
        <option>Rehabilitaci√≥n</option>
        <option>Pediatr√≠a</option>
        <option>Medicina Interna</option>
        <option>Neumolog√≠a</option>
         <option>Nutrici√≥n</option>
          <option>Psiquiatr√≠a</option>
      </select>
      <input placeholder="Registro M√©dico" id="regMedico" required />
      <input placeholder="Correo" id="correoMedico" type="email" required />
      <input placeholder="Tel√©fono" id="telMedico" required />
      <input placeholder="Disponibilidad " id="dispMedico" required />
      <button type="submit" class="btn btn-primary">Registrar M√©dico</button>
    </form>

    <table id="tablaMedicos" class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Especialidad</th>
          <th>Disponibilidad</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- ===================================================
         üìå GESTI√ìN DE PACIENTES
    =================================================== -->
    <h2>Gesti√≥n de Pacientes</h2>
    <form id="formPaciente" class="mb-3">
      <input placeholder="ID Paciente" id="idPaciente" required />
      <input placeholder="Nombres" id="nombrePaciente" required />
      <input placeholder="Apellidos" id="apellidoPaciente" required />
      <input type="date" id="fechaNacimiento" required />
      <input placeholder="Correo" type="email" id="correoPaciente" required />
      <input placeholder="Tel√©fono" id="telPaciente" required />
      <input placeholder="Direcci√≥n" id="dirPaciente" required />
      <button type="submit" class="btn btn-primary">Registrar Paciente</button>
    </form>

    <table id="tablaPacientes" class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Correo</th>
          <th>Tel√©fono</th>
          <th>Direcci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- ===================================================
         üìå AGENDAMIENTO DE CITAS
    =================================================== -->
    <h2>Agendamiento de Citas</h2>
    <form id="formCita" class="mb-3">
      <select id="pacienteCita" required></select>
      <select id="espCita" required></select>
      <select id="medicoCita" required></select>
      <input type="date" id="fechaCita" required />
      <input type="time" id="horaCita" required />
      <button type="submit" class="btn btn-success">Agendar Cita</button>
    </form>
    <p id="msgCita"></p>

    <h2>Historial de Citas</h2>
    <table id="tablaCitas" class="table table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Paciente</th>
          <th>M√©dico</th>
          <th>Especialidad</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    ¬© <span id="year"></span> Unimedic IPS ‚Äî Todos los derechos reservados
    <div class="redes">
      <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook"></i></a>
      <a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://wa.me/573178345647" target="_blank"><i class="fab fa-whatsapp"></i></a>
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const api = "http://localhost:3000";

    // ===============================
    // M√âDICOS
    // ===============================
    const formMedico = document.getElementById("formMedico");
    const tablaMedicos = document.querySelector("#tablaMedicos tbody");
    const espCita = document.getElementById("espCita");
    const medicoCita = document.getElementById("medicoCita");

    formMedico.addEventListener("submit", async e => {
      e.preventDefault();
      const nuevo = {
        id: idMedico.value,
        nombre: nombreMedico.value + " " + apellidoMedico.value,
        especialidad: espMedico.value,
        registro: regMedico.value,
        correo: correoMedico.value,
        tel: telMedico.value,
        disponibilidad: dispMedico.value
      };
      const res = await fetch(api + "/medicos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(nuevo)
      });
      const data = await res.json();
      alert(data.message || data.error);
      formMedico.reset();
      cargarMedicos();
    });

    async function cargarMedicos() {
      const res = await fetch(api + "/medicos");
      const medicos = await res.json();
      tablaMedicos.innerHTML = medicos.map(m => `
        <tr>
          <td>${m.id}</td>
          <td>${m.nombre}</td>
          <td>${m.especialidad}</td>
          <td>${m.disponibilidad}</td>
        </tr>`).join("");

      // Rellenar especialidades y m√©dicos para citas
      const especialidades = [...new Set(medicos.map(m => m.especialidad))];
      espCita.innerHTML = "<option value='' disabled selected>Especialidad</option>";
      especialidades.forEach(e => {
        espCita.innerHTML += `<option value="${e}">${e}</option>`;
      });

      espCita.addEventListener("change", () => {
        medicoCita.innerHTML = "<option value='' disabled selected>M√©dico</option>";
        medicos.filter(m => m.especialidad === espCita.value)
          .forEach(m => {
            medicoCita.innerHTML += `<option value="${m.id}">${m.nombre}</option>`;
          });
      });
    }

    // ===============================
    // PACIENTES
    // ===============================
    const formPaciente = document.getElementById("formPaciente");
    const tablaPacientes = document.querySelector("#tablaPacientes tbody");
    const pacienteCita = document.getElementById("pacienteCita");

    formPaciente.addEventListener("submit", async e => {
      e.preventDefault();
      const nuevo = {
        id: idPaciente.value,
        nombre: nombrePaciente.value + " " + apellidoPaciente.value,
        fecha_nacimiento: fechaNacimiento.value,
        correo: correoPaciente.value,
        tel: telPaciente.value,
        direccion: dirPaciente.value
      };
      const res = await fetch(api + "/pacientes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(nuevo)
      });
      const data = await res.json();
      alert(data.message || data.error);
      formPaciente.reset();
      cargarPacientes();
    });

    async function cargarPacientes() {
      const res = await fetch(api + "/pacientes");
      const pacientes = await res.json();
      tablaPacientes.innerHTML = pacientes.map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>${p.correo}</td>
          <td>${p.tel}</td>
          <td>${p.direccion}</td>
        </tr>`).join("");
      pacienteCita.innerHTML = "<option value='' disabled selected>Seleccione paciente</option>";
      pacientes.forEach(p => {
        pacienteCita.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
      });
    }

    // ===============================
    // CITAS
    // ===============================
    const formCita = document.getElementById("formCita");
    const tablaCitas = document.querySelector("#tablaCitas tbody");
    const msgCita = document.getElementById("msgCita");

    formCita.addEventListener("submit", async e => {
      e.preventDefault();
      const cita = {
        paciente_id: pacienteCita.value,
        medico_id: medicoCita.value,
        especialidad: espCita.value,
        fecha: fechaCita.value,
        hora: horaCita.value
      };
      const res = await fetch(api + "/citas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cita)
      });
      const data = await res.json();
      msgCita.textContent = data.message || data.error;
      cargarCitas();
    });

    async function cargarCitas() {
      const res = await fetch(api + "/citas");
      const citas = await res.json();
      tablaCitas.innerHTML = citas.map(c => `
        <tr>
          <td>${c.id}</td>
          <td>${c.paciente}</td>
          <td>${c.medico}</td>
          <td>${c.especialidad}</td>
          <td>${c.fecha}</td>
          <td>${c.hora}</td>
          <td>${c.estado}</td>
          <td>${c.estado === "Agendada" ? `<button onclick="cancelarCita(${c.id})" class='btn btn-danger btn-sm'>Cancelar</button>` : ""}</td>
        </tr>`).join("");
    }

    async function cancelarCita(id) {
      await fetch(api + `/citas/${id}/cancelar`, { method: "PUT" });
      alert("‚úÖ Cita cancelada correctamente");
      cargarCitas();
    }

    // ===============================
    // INICIALIZAR TODO
    // ===============================
    window.onload = () => {
      cargarMedicos();
      cargarPacientes();
      cargarCitas();
    };

 

  </script>
</body>
</html>
